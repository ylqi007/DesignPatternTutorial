## ä»£ç†æ¨¡å¼
1. ä»£ç†æ¨¡å¼: ä¸ºä¸€ä¸ª**å¯¹è±¡(target)æä¾›ä¸€ä¸ªæ›¿èº«**ï¼Œä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚å³é€šè¿‡ä»£ç†å¯¹è±¡(proxy)è®¿é—®ç›®æ ‡å¯¹è±¡(target)ã€‚
2. è¿™æ ·åšçš„å¥½å¤„æ˜¯: å¯ä»¥åœ¨ç›®æ ‡å¯¹è±¡å®ç°çš„åŸºç¡€ä¸Šï¼Œå¢å¼ºé¢å¤–çš„åŠŸèƒ½æ“ä½œï¼Œå³æ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚
3. è¢«ä»£ç†çš„å¯¹è±¡å¯ä»¥æ˜¯è¿œç¨‹å¯¹è±¡ã€åˆ›å»ºå¼€é”€å¤§çš„å¯¹è±¡oréœ€è¦å®‰å…¨æ§åˆ¶çš„å¯¹è±¡ã€‚
4. ä»£ç†æ¨¡å¼æœ‰ä¸åŒçš„å½¢å¼ï¼Œä¸»è¦æœ‰ä¸‰ç§:
   1. é™æ€ä»£ç†
   2. åŠ¨æ€ä»£ç†(JDKä»£ç†ï¼Œæ¥å£ä»£ç†)
   3. Cglibä»£ç†(å¯ä»¥åœ¨å†…å­˜åŠ¨æ€åˆ›å»ºå¯¹è±¡ï¼Œè€Œä¸éœ€è¦å®ç°æ¥å£ï¼Œä¹Ÿå¯ä»¥å±äºåŠ¨æ€ä»£ç†çš„èŒƒç•´)

**ä»£ç†æ¨¡å¼æ˜¯ä¸ºäº†å¢å¼ºåŠŸèƒ½ï¼Œæ‰©å±•åŠŸèƒ½ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡æ¥å¢å¼ºå’Œæ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½**

## 1. é™æ€ä»£ç†
![](images/Proxy.StaticProxy.png)
é™æ€ä»£ç†åœ¨ä½¿ç”¨æ—¶ï¼Œéœ€è¦å®šä¹‰æ¥å£æˆ–è€…çˆ¶ç±»ï¼Œè¢«ä»£ç†å¯¹è±¡(å³ç›®æ ‡å¯¹è±¡)ä¸ä»£ç†å¯¹è±¡ä¸€èµ·å®ç°ç›¸åŒçš„æ¥å£æˆ–è€…æ˜¯ç»§æ‰¿ç›¸åŒçš„çˆ¶ç±»ã€‚

**ä¼˜ç‚¹:**
1. åœ¨ä¸ä¿®æ”¹ç›®æ ‡å¯¹è±¡çš„å‰æä¸‹ï¼Œé€šè¿‡ä»£ç†ç›®æ ‡å¯¹è±¡å¯¹ç›®æ ‡åŠŸèƒ½æ‰©å±•

**ç¼ºç‚¹:**
1. å› ä¸ºä»£ç†å¯¹è±¡éœ€è¦ä¸ç›®æ ‡å¯¹è±¡å®ç°ä¸€æ ·çš„æ¥å£ï¼Œæ‰€ä»¥ä¼šæœ‰å¾ˆå¤šä»£ç†ç±»
2. ä¸€æ—¦æ¥å£å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡ä¸ä»£ç†å¯¹è±¡éƒ½éœ€è¦ç»´æŠ¤


## 2. åŠ¨æ€ä»£ç†
![](images/Proxy.DynamicProxy.png)
1. ä»£ç†å¯¹è±¡ä¸éœ€è¦å®ç°æ¥å£ï¼Œä½†æ˜¯ç›®æ ‡å¯¹è±¡éœ€è¦å®ç°æ¥å£ï¼Œå¦åˆ™ä¸èƒ½ç”¨åŠ¨æ€ä»£ç†
2. ä»£ç†å¯¹è±¡çš„ç”Ÿæˆæ˜¯åˆ©ç”¨JDKçš„åå°„APIï¼ŒåŠ¨æ€åœ°åœ¨å†…å­˜ä¸­æ„å»ºä»£ç†å¯¹è±¡
3. åŠ¨æ€ä»£ç†ä¹Ÿå«åš: JDKä»£ç†ï¼Œæ¥å£ä»£ç†

### 2.1 JDKä¸­ç”Ÿæˆä»£ç†å¯¹è±¡çš„API
1. ä»£ç†ç±»ï¼š`java.lang.reflect.Proxy`
2. JDKå®ç°ä»£ç†åªéœ€è¦ä½¿ç”¨`newProxyInstance`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•éœ€è¦ä¸‰ä¸ªå‚æ•°
   * `new Object newProxyInstance(ClassLoader loader, Class<?> interfaces, InvocationHandler h)`


* [java.lang.reflect.Proxy](https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/reflect/Proxy.html)


## 3. Cglibä»£ç†
1. é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†(JDKä»£ç†)éƒ½è¦æ±‚ç›®æ ‡å¯¹è±¡(target)å®ç°ä¸€ä¸ªæ¥å£ï¼Œä½†æ˜¯æœ‰æ—¶å€™ç›®æ ‡å¯¹è±¡åªæ˜¯ä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ï¼Œå¹¶æ²¡æœ‰å®ç°ä»»ä½•çš„æ¥å£ï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ç›®æ ‡å¯¹è±¡çš„**å­ç±»**å®ç°ä»£ç†ï¼Œè¿™å°±æ˜¯Cglibä»£ç†
2. Cglibä»£ç†ä¹Ÿå«åšå­ç±»ä»£ç†ï¼Œå®ƒæ˜¯åœ¨å†…å­˜ä¸­æ„å»ºä¸€ä¸ªå­ç±»å¯¹è±¡ä»è€Œå®ç°å¯¹ç›®æ ‡å¯¹è±¡åŠŸèƒ½æ‰©å±•ï¼Œæœ‰äº›ä¹¦ä¹Ÿå°†Cglibä»£ç†å½’å±åˆ°åŠ¨æ€ä»£ç†ã€‚
3. Cglibæ˜¯ä¸€ä¸ªå¼ºå¤§çš„é«˜æ€§èƒ½çš„ä»£ç ç”ŸæˆåŒ…ã€‚å®ƒå¯ä»¥åœ¨è¿è¡ŒæœŸé—´æ‰©å±•Javaç±»ä¸å®ç°Javaæ¥å£ã€‚å®ƒå¹¿æ³›çš„è¢«è®¸å¤šAOPçš„æ¡†æ¶ä½¿ç”¨ï¼Œä¾‹å¦‚Spring AOPï¼Œå®ç°æ–¹æ³•æ‹¦æˆªã€‚
4. åœ¨AOPç¼–ç¨‹ä¸­ï¼Œå¦‚ä½•é€‰æ‹©ä»£ç†æ¨¡å¼:
   1. ç›®æ ‡å¯¹è±¡**éœ€è¦**å®ç°æ¥å£: ç”¨åŠ¨æ€ä»£ç†(JDKä»£ç†)
   2. ç›®æ ‡å¯¹è±¡ä¸éœ€è¦å®ç°æ¥å£: Cglibä»£ç†
5. CglibåŒ…çš„åº•å±‚æ˜¯é€šè¿‡ä½¿ç”¨å­—èŠ‚ç å¤„ç†æ¡†æ¶ASMæ¥è½¬æ¢å­—èŠ‚ç å¹¶ç”Ÿæˆæ–°çš„ç±»

è¦æ±‚:
1. å¼•å…¥cglibçš„jaråŒ…
2. åœ¨å†…å­˜ä¸­åŠ¨æ€æ„å»ºå­ç±»ï¼Œæ³¨æ„ä»£ç†çš„ç±»ä¸èƒ½ä¸ºfinalç±»ï¼Œå¦åˆ™æŠ¥é”™`java.lang.IllegalArgumentException`
3. ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•å¦‚æœä¸º`final/static`ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¢«æ‹¦æˆªï¼Œå³ä¸ä¼šæ‰§è¡Œç›®æ ‡å¯¹è±¡é¢å¤–çš„ä¸šåŠ¡ã€‚

âš ï¸æ³¨æ„:
1. å› ä¸ºJDK17å¼•å…¥äº†æ–°ç‰¹æ€§ï¼ŒåŒ…æ‹¬`403: Strong Encapsulate JDK Internals å¼ºå°è£…JDKçš„å†…éƒ¨APIï¼Œæ— æ³•æš´åŠ›åå°„`
   1. [Reflection StringTest](https://github.com/ylqi007/JavaTutorial/blob/main/src/main/java/com/atguigu/reflection/interview/StringTest.java)
2. å¦‚ä½•è§£å†³ï¼Ÿæ·»åŠ JVM OPTIONS
   1. [Java 17 InaccessibleObjectException](https://medium.com/@rajvirsinghrai/java-17-inaccessibleobjectexception-bf030a348e48)
   2. [Java 16 and 17 compatibility #191](https://github.com/cglib/cglib/issues/191)
   3. [Ideaä¸­ä¸ºjavaç¨‹åºæ·»åŠ å¯åŠ¨å‚æ•°ï¼ˆå«ï¼šVM optionsã€Program argumentsã€Environment variableï¼‰](https://blog.51cto.com/Saintmm/5573298)

Step 1: æŒ‰ç…§ä¸Šé¢çš„å¸–å­æ·»åŠ JVM OPTIONS
![](images/Set.JVM.Options.png)

Step 2: Run `main()` method againï¼Œç„¶åå¯ä»¥çœ‹åˆ°Run Consoleä¸­æ‰§è¡Œçš„ä»£ç å¦‚ä¸‹
```shell
/Library/Java/JavaVirtualMachines/amazon-corretto-17.jdk/Contents/Home/bin/java --add-exports=java.naming/com.sun.jndi.ldap=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.lang.invoke=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.security=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.management/javax.management=ALL-UNNAMED --add-opens=java.naming/javax.naming=ALL-UNNAMED -javaagent:/Users/userName/Library/Application Support/JetBrains/Toolbox/apps/IDEA-U/ch-0/231.9161.38/IntelliJ IDEA.app/Contents/lib/idea_rt.jar=60625:/Users/userName/Library/Application Support/JetBrains/Toolbox/apps/IDEA-U/ch-0/231.9161.38/IntelliJ IDEA.app/Contents/bin -Dfile.encoding=UTF-8 -classpath /Users/userName/Work/IDEA/DesignPatternTutorial/target/classes:/Users/userName/.m2/repository/cglib/cglib/3.3.0/cglib-3.3.0.jar:/Users/userName/.m2/repository/org/ow2/asm/asm/7.1/asm-7.1.jar com.atguigu.proxy.cglib.Client
```
* Note: I replaced real user name with `userName`


## 4. ä»£ç†æ¨¡å¼çš„å˜ä½“
1. é˜²ç«å¢™ä»£ç†: å†…ç½‘é€šè¿‡ä»£ç†ç©¿é€é˜²ç«å¢™ï¼Œå®ç°å¯¹å…¬ç½‘çš„è®¿é—®
2. ç¼“å­˜ä»£ç†: æ¯”å¦‚ï¼Œå½“è¯·æ±‚å›¾ç‰‡æ–‡ä»¶ç­‰èµ„æºæ—¶ï¼Œå…ˆåˆ°ç¼“å­˜ä»£ç†å–ï¼Œå¦‚æœå–åˆ°åˆ™OKï¼Œå¦‚æœå–ä¸åˆ°èµ„æºï¼Œå†åˆ°å…¬ç½‘æˆ–è€…æ•°æ®åº“å–ï¼Œç„¶åç¼“å­˜ã€‚
3. è¿œç¨‹ä»£ç†: è¿œç¨‹å¯¹è±¡çš„æœ¬åœ°ä»£è¡¨ï¼Œé€šè¿‡å®ƒå¯ä»¥æŠŠè¿œç¨‹å¯¹è±¡å½“ä½œæœ¬åœ°å¯¹è±¡æ¥è°ƒç”¨ã€‚è¿œç¨‹ä»£ç†é€šè¿‡ç½‘ç»œå’ŒçœŸæ­£çš„è¿œç¨‹å¯¹è±¡æ²Ÿé€šä¿¡æ¯ã€‚ 
4. åŒæ­¥ä»£ç†: ä¸»è¦ä½¿ç”¨åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œå®Œæˆå¤šçº¿ç¨‹é—´åŒæ­¥å·¥ä½œã€‚


## Reference
* Youtube: å°šç¡…è°· è®¾è®¡æ¨¡å¼ éŸ©é¡ºå¹³
* [ä»£ç†æ¨¡å¼](https://www.runoob.com/design-pattern/proxy-pattern.html) (ä¾‹å­)
* [ä»£ç†æ¨¡å¼](https://refactoringguru.cn/design-patterns/proxy) (ä¾‹å­)
* [Java ä»£ç†æ¨¡å¼è¯¦è§£](https://javaguide.cn/java/basis/proxy.html)
* [ã€Œè®¾è®¡æ¨¡å¼ã€ğŸ³ï¸â€ğŸŒˆä»£ç†æ¨¡å¼ï¼ˆProxyï¼‰](https://juejin.cn/post/7088115791052144654)
* [6. ä»£ç†æ¨¡å¼](https://design-patterns.readthedocs.io/zh-cn/latest/structural_patterns/proxy.html)
* [Proxyï¼ˆä»£ç†æ¨¡å¼ï¼‰](https://github.com/ascoders/weekly/blob/master/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/178.%E7%B2%BE%E8%AF%BB%E3%80%8A%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20Proxy%20%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E3%80%8B.md)
* [è®¾è®¡æ¨¡å¼ï¼ˆå››ï¼‰â€”â€”ææ‡‚ä»€ä¹ˆæ˜¯ä»£ç†æ¨¡å¼](https://zhuanlan.zhihu.com/p/72644638)